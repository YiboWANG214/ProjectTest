<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RedisConfigurationBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">o1redis</a> &gt; <a href="index.source.html" class="el_package">projecteval.redis</a> &gt; <span class="el_source">RedisConfigurationBuilder.java</span></div><h1>RedisConfigurationBuilder.java</h1><pre class="source lang-java linenums">package projecteval.redis;

import org.apache.ibatis.cache.CacheException;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.reflection.MetaObject;
import org.apache.ibatis.reflection.SystemMetaObject;

import java.io.IOException;
import java.io.InputStream;
import java.util.Arrays;
import java.util.Map;
import java.util.Properties;

/**
 * Converter from the Config to a proper {@link RedisConfig}.
 *
 * @author Eduardo Macarron
 */
final class RedisConfigurationBuilder {

    /**
     * This class instance.
     */
<span class="fc" id="L24">    private static final RedisConfigurationBuilder INSTANCE = new RedisConfigurationBuilder();</span>

    protected static final String SYSTEM_PROPERTY_REDIS_PROPERTIES_FILENAME = &quot;redis.properties.filename&quot;;

    protected static final String REDIS_RESOURCE = &quot;redis.properties&quot;;

    /**
     * Hidden constructor, this class can't be instantiated.
     */
    private RedisConfigurationBuilder() {
    }

    /**
     * Return this class instance.
     *
     * @return this class instance.
     */
    public static RedisConfigurationBuilder getInstance() {
<span class="fc" id="L42">        return INSTANCE;</span>
    }

    /**
     * Parses the Config and builds a new {@link RedisConfig}.
     *
     * @return the converted {@link RedisConfig}.
     */
    public RedisConfig parseConfiguration() {
<span class="fc" id="L51">        return parseConfiguration(getClass().getClassLoader());</span>
    }

    /**
     * Parses the Config and builds a new {@link RedisConfig}.
     *
     * @param the {@link ClassLoader} used to load the {@code memcached.properties} file in classpath.
     * @return the converted {@link RedisConfig}.
     */
    public RedisConfig parseConfiguration(ClassLoader classLoader) {
<span class="fc" id="L61">        Properties config = new Properties();</span>

<span class="fc" id="L63">        String redisPropertiesFilename = System.getProperty(SYSTEM_PROPERTY_REDIS_PROPERTIES_FILENAME, REDIS_RESOURCE);</span>

<span class="fc" id="L65">        try (InputStream input = classLoader.getResourceAsStream(redisPropertiesFilename)) {</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">            if (input != null) {</span>
<span class="fc" id="L67">                config.load(input);</span>
            }
<span class="nc" id="L69">        } catch (IOException e) {</span>
<span class="nc" id="L70">            throw new RuntimeException(</span>
                    &quot;An error occurred while reading classpath property '&quot; + redisPropertiesFilename + &quot;', see nested exceptions&quot;,
                    e);
<span class="fc" id="L73">        }</span>

<span class="fc" id="L75">        RedisConfig jedisConfig = new RedisConfig();</span>
<span class="fc" id="L76">        setConfigProperties(config, jedisConfig);</span>
<span class="fc" id="L77">        return jedisConfig;</span>
    }

    private void setConfigProperties(Properties properties, RedisConfig jedisConfig) {
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (properties != null) {</span>
<span class="fc" id="L82">            MetaObject metaCache = SystemMetaObject.forObject(jedisConfig);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">            for (Map.Entry&lt;Object, Object&gt; entry : properties.entrySet()) {</span>
<span class="fc" id="L84">                String name = (String) entry.getKey();</span>
                // All prefix of 'redis.' on property values
<span class="pc bpc" id="L86" title="2 of 4 branches missed.">                if (name != null &amp;&amp; name.startsWith(&quot;redis.&quot;)) {</span>
<span class="fc" id="L87">                    name = name.substring(6);</span>
                } else {
                    // Skip non prefixed properties
                    continue;
                }
<span class="fc" id="L92">                String value = (String) entry.getValue();</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">                if (&quot;serializer&quot;.equals(name)) {</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">                    if (&quot;kryo&quot;.equalsIgnoreCase(value)) {</span>
<span class="fc" id="L95">                        jedisConfig.setSerializer(KryoSerializer.INSTANCE);</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">                    } else if (!&quot;jdk&quot;.equalsIgnoreCase(value)) {</span>
                        // Custom serializer is not supported yet.
<span class="fc" id="L98">                        throw new CacheException(&quot;Unknown serializer: '&quot; + value + &quot;'&quot;);</span>
                    }
<span class="fc bfc" id="L100" title="All 2 branches covered.">                } else if (Arrays.asList(&quot;sslSocketFactory&quot;, &quot;sslParameters&quot;, &quot;hostnameVerifier&quot;).contains(name)) {</span>
<span class="nc" id="L101">                    setInstance(metaCache, name, value);</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">                } else if (metaCache.hasSetter(name)) {</span>
<span class="fc" id="L103">                    Class&lt;?&gt; type = metaCache.getSetterType(name);</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">                    if (String.class == type) {</span>
<span class="fc" id="L105">                        metaCache.setValue(name, value);</span>
<span class="pc bpc" id="L106" title="3 of 4 branches missed.">                    } else if (int.class == type || Integer.class == type) {</span>
<span class="fc" id="L107">                        metaCache.setValue(name, Integer.valueOf(value));</span>
<span class="nc bnc" id="L108" title="All 4 branches missed.">                    } else if (long.class == type || Long.class == type) {</span>
<span class="nc" id="L109">                        metaCache.setValue(name, Long.valueOf(value));</span>
<span class="nc bnc" id="L110" title="All 4 branches missed.">                    } else if (short.class == type || Short.class == type) {</span>
<span class="nc" id="L111">                        metaCache.setValue(name, Short.valueOf(value));</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">                    } else if (byte.class == type || Byte.class == type) {</span>
<span class="nc" id="L113">                        metaCache.setValue(name, Byte.valueOf(value));</span>
<span class="nc bnc" id="L114" title="All 4 branches missed.">                    } else if (float.class == type || Float.class == type) {</span>
<span class="nc" id="L115">                        metaCache.setValue(name, Float.valueOf(value));</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">                    } else if (boolean.class == type || Boolean.class == type) {</span>
<span class="nc" id="L117">                        metaCache.setValue(name, Boolean.valueOf(value));</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">                    } else if (double.class == type || Double.class == type) {</span>
<span class="nc" id="L119">                        metaCache.setValue(name, Double.valueOf(value));</span>
                    } else {
<span class="nc" id="L121">                        throw new CacheException(&quot;Unsupported property type: '&quot; + name + &quot;' of type &quot; + type);</span>
                    }
                }
<span class="fc" id="L124">            }</span>
        }
<span class="fc" id="L126">    }</span>

    protected void setInstance(MetaObject metaCache, String name, String value) {
<span class="pc bpc" id="L129" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L130">            return;</span>
        }
        Object instance;
        try {
<span class="fc" id="L134">            Class&lt;?&gt; clazz = Resources.classForName(value);</span>
<span class="nc" id="L135">            instance = clazz.getDeclaredConstructor().newInstance();</span>
<span class="fc" id="L136">        } catch (Exception e) {</span>
<span class="fc" id="L137">            throw new CacheException(&quot;Could not instantiate class: '&quot; + value + &quot;'.&quot;, e);</span>
<span class="nc" id="L138">        }</span>
<span class="nc" id="L139">        metaCache.setValue(name, instance);</span>
<span class="nc" id="L140">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>